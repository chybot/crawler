# -*- coding: utf-8 -*-# Created by fml on 2016/5/18.import sysimport randomimport refrom json import JSONDecoderreload(sys)sys.path.append('./util')from CrawlerBase import CrawlerBaseimport jsonfrom ModuleManager import Module,Event,Iterator,Sleepfrom util.crawler_util import CrawlerRunMode, InputType, OutputType, EventType, OutputParameterShowUpTypefrom CommonLib.WebContent import WebAccessType, SeedAccessTypeclass CrawlerLiaoning(CrawlerBase):    def __init__(self,pinyin, callbackFromOuterControl):        config_dict = dict()        config_dict[CrawlerRunMode.COMPANY_KEY] = [self.initYzmPic,self.initSearchList,self.initCompanyInfo]        config_dict[CrawlerRunMode.COMPANY_URL] = [self.initCompanyInfoPrepare,self.initTopinfo,self.initVistJBxxInfo,        self.initBaxx,        self.initBgxx,        self.initGdxx,        self.initFzjgxx,        self.initXzcf,        self.initNianbao,        self.initNbprepare,        self.initResultCollect]        check_dict = dict()        CrawlerBase.__init__(self, pinyin, config_dict, check_dict, callbackFromOuterControl)    def initYzmPic(self):        module = Module(self.visitValidateCode, "获取验证码图片")        module.module_id = "yzm_pic"        #后面产生的随机数整除3的url为数据类型        module.appendUrl('http://gsxt.lngs.gov.cn/saicpub/commonsSC/loginDC/securityCode.action?tdate=%s'%str((int(random.random()*100000)//3)*3))        module.appendHeaders({            "Host": "gsxt.lngs.gov.cn",            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0",            "Accept": "image/png,image/*;q=0.8,*/*;q=0.5",            "Accept-Language": "zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3",            "Accept-Encoding": "gzip, deflate",            "Referer": "http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/entPublicity/search/searchmain.jsp",            "Connection": "keep-alive"        })        module.addSleep(Sleep(3))        def postDataJsonAssert(yzm = None):            if yzm == None and str(yzm) == '-9999':                print yzm                return False            return True        module.addEvent(Event(EventType.ASSERT_FAILED, assert_function=postDataJsonAssert, redo_module="yzm_pic",retry_times=100))        self.module_manager.appendSubModule(module,supportDefaultEvent=True)    def initSearchList(self):        module = Module(self.getWebHtml, '获取公司列表')        module.appendUrl('http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/lngsSearchFpc.action')        module.appendHeaders({            "Host": "gsxt.lngs.gov.cn",            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0",            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",            "Accept-Language": "zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3",            "Accept-Encoding": "gzip, deflate",            "Referer": "http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/entPublicity/search/searchmain.jsp",            "Connection": "keep-alive",            "Content-Type": "application/x-www-form-urlencoded"        })        module.appendWebMethod('post')        module.appendPostData(lambda yzm, company_key: {"authCode": yzm, "solrCondition": company_key})        module.addSleep(Sleep(6))        def postDataJsonAssert(html=None):            if html == None:                return False            if re.search(u'var\s*?codevalidator\\=\s*?\\"fail\\"\\;', unicode(html)):                return False            return True        def getSearchList(html=None):            parem = re.compile(r"searchList_paging(.*?)var\s*?codevalidator", re.S)            bodys = re.findall(parem, html)            if not bodys:                return []            bodys = bodys[0]            _list = self.getjsonstr(bodys)            return _list        def postDataJsonAssert1(html=''):            if re.search(u"您搜索的条件无查询结果", unicode(html)):                self.report.access_type = SeedAccessType.NON_COMPANY                self.holder.logging.info("无此公司！")                return False            return True        module.addEvent(Event(EventType.ASSERT_FAILED, assert_function=postDataJsonAssert, redo_module="yzm_pic",retry_times=100))        module.addEvent(Event(EventType.ASSERT_FAILED, retry_times=100, assert_function=postDataJsonAssert1,redo_module="yzm_pic"))        module.appendOutput("search_list", type=OutputType.FUNCTION, function=getSearchList,                            show_up=OutputParameterShowUpType.OPTIONAL)        module.addEvent(Event(EventType.EXCEPTION_OCCURED, retry_times=100, redo_module='yzm_pic'))        module.addSleep(Sleep(3))        self.module_manager.appendSubModule(module)    def getjsonstr(self,str):        str = str.strip()        start = str.find('{')        fstart = str.find('[')        if fstart >= 0 and (fstart < start or start < 0):            start = fstart            end = str.rfind("]")        else:            end = str.rfind('}')        if start > -1 and end > start:            json_str = str[start:end + 1]            return JSONDecoder().decode(json_str)    def initCompanyInfo(self):        iterator = Iterator("search_list", "company")        module = Module(None, "获取公司信息", iterator)        self.module_manager.appendSubModule(module, True)        self.initCompanyInfoPrepare(module)        self.initTopinfo(module)        self.initVistJBxxInfo(module)        self.initBaxx(module)        self.initBgxx(module)        self.initGdxx(module)        self.initFzjgxx(module)        self.initXzcf(module)        self.initNianbao(module)        self.initNbprepare(module)        self.initResultCollect(module)    def initCompanyInfoPrepare(self,super_module):        module = Module(None, "抓取公司前的预处理")        module.addSleep(Sleep(2))        def prepare(company):            query_ = dict()            query_.update(company)            query_['search_company'] = company.get('entname','').strip()            query_['zch'] = company.get('regno','').strip()            return query_        module.appendOutput(type=OutputType.FUNCTION, function=prepare)        super_module.appendSubModule(module, True)    def initTopinfo(self,super_module):        module = Module(self.visitTopInfo, "抓取公司的TOP信息")        module.addSleep(Sleep(2))        module.appendUrl('http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/sEntDetail.action')        module.appendHeaders({            "Host": "gsxt.lngs.gov.cn",            "User-Agent": "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0",            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",            "Accept-Language": "zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3",            "Accept-Encoding": "gzip, deflate",            "Referer": "http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/lngsSearchFpc.action",            "Connection": "keep-alive",            "Content-Type": "application/x-www-form-urlencoded"        })        module.appendWebMethod('post')        module.appendPostData(lambda pripid,entname,regno,enttype,optstate,revdate:{                                                                "pripid": pripid,                                                                "entname":entname,                                                                "regno": regno,                                                                "enttype": enttype,                                                                "opstate": optstate,                                                                "revdate": revdate                                                            })        super_module.appendSubModule(module, True)    def initVistJBxxInfo(self,super_module):        module = Module(self.visitJbxx, "抓取公司的基本信息")        module.addSleep(Sleep(1))        module.appendUrl(lambda pripid,enttype:'http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/getJbxxAction.action?pripid=%s&type=%s'%(pripid,enttype))        module.appendHeaders({            "Host": "gsxt.lngs.gov.cn",            "User-Agent": "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0",            "Accept": "text/html, */*; q=0.01",            "Accept-Language": "zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3",            "Accept-Encoding": "gzip, deflate",            "X-Requested-With": "XMLHttpRequest",            "Referer": "http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/sEntDetail.action",            "Connection": "keep-alive"        })        super_module.appendSubModule(module, True)    def initBaxx(self,super_module):        module = Module(self.visitBaxx, "抓取公司的备案信息")        module.addSleep(Sleep(1))        module.appendUrl(lambda pripid,enttype:'http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/getZyryxxAction.action?pripid=%s&type=%s'%(pripid,enttype))        module.appendHeaders({            "Host": "gsxt.lngs.gov.cn",            "User-Agent": "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0",            "Accept": "text/html, */*; q=0.01",            "Accept-Language": "zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3",            "Accept-Encoding": "gzip, deflate",            "X-Requested-With": "XMLHttpRequest",            "Referer": "http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/sEntDetail.action",            "Connection": "keep-alive"        })        super_module.appendSubModule(module, True)    def initTzrxx(self, super_module):        module = Module(self.visitBaxx, "抓取公司的备案信息")        module.addSleep(Sleep(1))        def urls(html=None):            if not html:                return True            if  re.search(r"\((\[.*?\}\])", str(html)):                return False            return True        module.appendUrl(lambda pripid,enttype:'http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/getTzrxxAction.action?pripid=%s&type=%s'%(pripid,enttype) if urls else None)        module.appendHeaders({            "Host": "gsxt.lngs.gov.cn",            "User-Agent": "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0",            "Accept": "text/html, */*; q=0.01",            "Accept-Language": "zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3",            "Accept-Encoding": "gzip, deflate",            "X-Requested-With": "XMLHttpRequest",            "Referer": "http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/sEntDetail.action",            "Connection": "keep-alive"        })        super_module.appendSubModule(module, True)    def initBgxx(self, super_module):        module = Module(self.visitBgxx, "抓取公司的变更信息")        module.addSleep(Sleep(1))        module.appendUrl(lambda pripid,enttype:'http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/getBgxxAction.action?pripid=%s&type=%s'%(pripid,enttype))        module.appendHeaders({            "Host": "gsxt.lngs.gov.cn",            "User-Agent": "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0",            "Accept": "text/html, */*; q=0.01",            "Accept-Language": "zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3",            "Accept-Encoding": "gzip, deflate",            "X-Requested-With": "XMLHttpRequest",            "Referer": "http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/sEntDetail.action",            "Connection": "keep-alive"        })        super_module.appendSubModule(module, True)    def initGdxx(self, super_module):        module = Module(self.visitGdxx, "抓取公司的股东信息")        module.addSleep(Sleep(1))        module.appendUrl(lambda pripid,enttype:'http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/getTzrxxAction.action?pripid=%s&type=%s'%(pripid,enttype))        module.appendHeaders({            "Host": "gsxt.lngs.gov.cn",            "User-Agent": "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0",            "Accept": "text/html, */*; q=0.01",            "Accept-Language": "zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3",            "Accept-Encoding": "gzip, deflate",            "X-Requested-With": "XMLHttpRequest",            "Referer": "http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/sEntDetail.action",            "Connection": "keep-alive"        })        super_module.appendSubModule(module, True)    def initFzjgxx(self, super_module):        module = Module(self.visitFzjg, "抓取公司的分支机构信息")        module.addSleep(Sleep(1))        module.appendUrl(lambda pripid,enttype:'http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/getFgsxxAction.action?pripid=%s&type=%s'%(pripid,enttype))        module.appendHeaders({            "Host": "gsxt.lngs.gov.cn",            "User-Agent": "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0",            "Accept": "text/html, */*; q=0.01",            "Accept-Language": "zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3",            "Accept-Encoding": "gzip, deflate",            "X-Requested-With": "XMLHttpRequest",            "Referer": "http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/sEntDetail.action",            "Connection": "keep-alive"        })        super_module.appendSubModule(module, True)    def initXzcf(self, super_module):        module = Module(self.visitXzcf, "抓取公司的行政处罚信息")        module.addSleep(Sleep(1))        module.appendUrl(lambda pripid,enttype:'http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/getXzcfxxAction.action?pripid=%s&type=%s'%(pripid,enttype))        module.appendHeaders({            "Host": "gsxt.lngs.gov.cn",            "User-Agent": "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0",            "Accept": "text/html, */*; q=0.01",            "Accept-Language": "zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3",            "Accept-Encoding": "gzip, deflate",            "X-Requested-With": "XMLHttpRequest",            "Referer": "http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/sEntDetail.action",            "Connection": "keep-alive"        })        super_module.appendSubModule(module, True)    def setRowKey(self, map_dict=None):        _dict = {}        _dict['company_name'] = self.value_dict['search_company']        _dict['company_zch'] = self.value_dict['zch']        self.page_dict['rowkey_dict'] = _dict        return True    def initNianbao(self,module_super):        module = Module(self.getWebHtml, "抓取公司的年报信息")        module.addSleep(Sleep(1))        module.appendUrl(lambda pripid,enttype:'http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/getQygsQynbxxAction.action?pripid=%s&type=%s' % (pripid,enttype))        module.appendHeaders({            "Host": "gsxt.lngs.gov.cn",            "User-Agent": "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0",            "Accept": "text/html, */*; q=0.01",            "Accept-Language": "zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3",            "Accept-Encoding": "gzip, deflate",            "X-Requested-With": "XMLHttpRequest",            "Referer": "http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/sEntDetail.action",            "Connection": "keep-alive"        })        def getNblist(html=None):            _list = []            str_list = re.search(u'qynbPaging\((\[.+?\])', html)            if str_list:                str_list = str_list.group(1)                return json.loads(str_list)            return _list        module.appendOutput('qynb_list',type=OutputType.FUNCTION, function=getNblist,show_up=OutputParameterShowUpType.OPTIONAL)        module_super.appendSubModule(module, True)    def initNbprepare(self,module_super):        iterator = Iterator(seeds="qynb_list", param_name="nianb")        module = Module(None, u"获取公司年报", iterator)        module_super.appendSubModule(module, True)        self.prepareNBxx(module)        self.initNbiter(module)    def prepareNBxx(self,module_super):        module = Module(None, u"抓取年报-预处理")        def prepare(nianb):            mv_dict = dict()            mv_dict['nb_name'] = nianb.get('ancheyear')            mv_dict['artid'] = nianb.get('artid','')            return mv_dict        module.appendOutput(type=OutputType.FUNCTION, function=prepare)        module_super.appendSubModule(module, True)    def initNbiter(self,module_super):        sub_module = Module(self.visitQynb, u"获取年报详情")        sub_module.appendUrl(lambda artid,enttype: 'http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/nbDeatil.action?artId=%s&entType=%s' %(artid,enttype))        sub_module.appendHeaders({"Host": "gsxt.lngs.gov.cn",                                "User-Agent": "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0",                                "Accept": "text/html, */*; q=0.01",                                "Accept-Language": "zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3",                                "Accept-Encoding": "gzip, deflate",                                "X-Requested-With": "XMLHttpRequest",                                "Referer": "http://gsxt.lngs.gov.cn/saicpub/entPublicitySC/entPublicityDC/sEntDetail.action",                                "Connection": "keep-alive"})        module_super.appendSubModule(sub_module)    def initResultCollect(self, module_super):        module = Module(self.resultCollect, "结果收集")        module_super.appendSubModule(module)